# 🧠 AI Agent 指南 — 波弟消消樂

本文件旨在幫助後續接手的 AI Agent 快速理解本專案的設計哲學、技術重點與已解決的坑位。

## 🎯 專案核心思維
- **手感優先**：三消遊戲的精隨在於連鎖動畫的流暢度與方塊大小的視覺舒適度。
- **輕量化**：儘量使用原生 API（Web Audio, Canvas）而不依賴大型庫，以確保在手機瀏覽器上即開即玩。
- **自適應**：棋盤必須在不同比例的螢幕上都能最大化顯示。

## 🏗 技術架構
- `js/game.js`: 核心邏輯層（Board, Game）。不涉及任何 DOM 或畫布操作，只處理資料與狀態。
- `js/renderer.js`: 渲染層。負責 Canvas 繪製、動畫插值計算、尺寸自適應邏輯。
- `js/input.js`: 輸入處理層。將滑鼠與觸控事件轉換為邏輯座標（支援 Swipe）。
- `js/audio.js`: 音效層。使用 Web Audio API 生成合成音。
- `js/main.js`: 粘合層。負責初始化與綁定 UI。

## ⚠️ 關鍵技術細節 (Gotchas & Solutions)

### 1. 棋盤縮放與「紅色死區」問題
- **痛點**：舊邏輯使用 `Math.min(innerWidth, innerHeight)`，在橫向螢幕或 UI 元素較多時，棋盤會被高度嚴重壓縮，導致兩側留下大量空白。
- **現行方案**：在 `renderer.js` 的 `_calcDimensions` 中，**優先根據寬度計算 `cellSize`**。寧可讓頁面產生垂直捲動，也要確保橫向填滿。
- **重要參數**：`sidePad` (左右邊界) 與 `maxByWidth` (最大限制)。

### 2. 素材透明邊界問題
- **痛點**：`assets/images/gem*.png` 圖片本身在繪製時，因為原始素材檔案周圍有較多透明空間，會導致方塊在格子內看起來很小。
- **現行方案**：在 `_drawGem` 渲染時，使用 `zoom` 係數（如 1.05 ~ 1.15）來擴張 `drawImage` 的範圍，並小心使用 `ctx.clip()` 以免切掉放大的圖像。

### 3. 移動端互動
- **滑動交換**：支援 `swipe` 機制。位於 `input.js` 中，透過 `_swipeThreshold` 判定是點擊還是滑動。

### 4. 影片區段循環慶祝 (Video Segment Control)
- **痛點**：靜態圖片缺乏打擊感，且全長影片重複播放太佔資源或讀取太久。
- **現行方案**：使用單一影片檔 `cheer.mp4`，但在 `js/main.js` 中監聽 `timeupdate` 事件。
  - **Normal 狀態**：鎖定在 1s - 2.5s 循環（平滑待機）。
  - **Cheer 狀態**：連鎖消除時直接跳轉至 3s 播放至 8s。
- **佈局**：位於控制區下方的 `.video-wrapper`，非絕對定位於 Canvas 上，以防遮擋操作。

## 🛠 未來開發方向建議
1. **粒子效果優化**：目前的消除動畫可以再增加粒子噴發感。
2. **特殊方塊**：可以新增「炸彈貓」或「閃電貓」方塊（匹配 4 個或 T 字型消除時生成）。
3. **更豐富的背景**：目前是靜態漸層，可以考慮加入輕微動態。

## 💡 給下一位 Agent 的話
修改 `renderer.js` 時，請務必先檢查 `_calcDimensions`，這關乎到遊戲在手機上的第一印象。如果玩家反應「方塊變小」或「兩側空白」，通常是寬高比例計算被限制住了。
